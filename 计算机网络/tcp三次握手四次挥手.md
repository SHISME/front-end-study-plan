## tcp 基础

tcp 是传输层的协议，tcp 是可靠传输，因为在建立连接之前会进行三次握手来确认连接。tcp协议中我主要要知道的有四个字段

- Sequence Number是包的序号，用来解决网络包乱序（reordering）问题。
- Acknowledgement Number就是ACK——用于确认收到，用来解决不丢包的问题。
- Window又叫Advertised-Window，也就是著名的滑动窗口（Sliding Window），用于解决流控的。
- TCP Flag ，也就是包的类型，主要是用于操控TCP的状态机的。

### 三次握手

三次握手是因为第二次的包，服务器可以把ACK和SYN一起发过来

1. 首先client向服务器发起 SYN 的包，Seq = X
2. 服务器接受到请求之后，会返回一个ACK，SYN的包, Seq 为 Y，ack = X + 1
3. client 接收到数据包后会返回 ACK 包，Seq = Z, ack = Y + 1

### 四次挥手

四次挥手是因为，当服务器接收到断开请求的包，不能马上断开，因为这时候可能还有数据在发送

1. client 向服务器发起断开连接的请求, 发送一个FIN的包，Seq = X,
2. 服务器收到请求，会返回一个ACK包， ack = X + 1,
3. 服务器在数据发送完之后，会向客户端发送一个FIN 包，Seq = Y 的包
4. 客户端在接收到FIN包之后，会返回一个ACK包， ack = Y +1

### 滑动窗口

由于数接收方不可能无限制的接收数据，如果发送方无限制的发送数据，接收方来不及接收而导致丢包，这样就很容易造成网络拥堵。
tcp 有一个Window字段是描述窗口的大小的，发送方和接收方的窗口大小是一致的。

### 快速重传机制

于是，TCP引入了一种叫Fast Retransmit 的算法，不以时间驱动，而以数据驱动重传。
也就是说，如果，包没有连续到达，就ack最后那个可能被丢了的包，如果发送方连续收到3次相同的ack，就重传。
Fast Retransmit的好处是不用等timeout了再重传。

比如：如果发送方发出了1，2，3，4，5份数据，第一份先到送了，于是就ack回2，
结果2因为某些原因没收到，3到达了，于是还是ack回2，后面的4和5都到了，但是还是ack回2，
因为2还是没有收到，于是发送端收到了三个ack=2的确认，知道了2还没有到，于是就马上重转2。
然后，接收端收到了2，此时因为3，4，5都收到了，于是ack回6。

### SACK 方法

由于上一步无法知道2后面的包有哪些接收到了，SACK 会发送哪些部分是接收到的。这个协议需要两边都支持。在 Linux下，可以通过tcp_sack参数打开这个功能（Linux 2.4后默认打开）。

### Duplicate SACK – 重复收到数据的问题

Duplicate SACK又称D-SACK，其主要使用了SACK来告诉发送方有哪些数据被重复接收了。

引入了D-SACK，有这么几个好处：

- 1）可以让发送方知道，是发出去的包丢了，还是回来的ACK包丢了。
- 2）是不是自己的timeout太小了，导致重传。
- 3）网络上出现了先发的包后到的情况（又称reordering）
- 4）网络上是不是把我的数据包给复制了。

其实引入这些字段都是为了帮助TCP了解网络情况，从而可以更好的做网络上的流控。


### 拥塞处理

TCP的设计理念是：TCP不是一个自私的协议，当拥塞发生的时候，要做自我牺牲。就像交通阻塞一样，每个车都应该把路让出来，而不要再去抢路了。

拥塞控制主要是四个算法：1）慢启动，2）拥塞避免，3）拥塞发生，4）快速恢复。



